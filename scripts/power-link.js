/*
✨ CoonDev • https://dev.coonlink.com/

 ▄█▄    ████▄ ████▄    ▄   ██▄   ▄███▄      ▄
 █▀ ▀▄  █   █ █   █     █  █  █  █▀   ▀      █
 █   ▀  █   █ █   █ ██   █ █   █ ██▄▄   █     █
 █▄  ▄▀ ▀████ ▀████ █ █  █ █  █  █▄   ▄▀ █    █
 ▀███▀              █  █ █ ███▀  ▀███▀    █  █
                    █   ██                 █▐
                                           ▐
*/

!function(){class t{constructor(t={}){this.container=t.container,this.nodes=[],this.connections=[],this.isDragging=!1,this.isDraggingNode=!1,this.tempLine=null,this.draggedNode=null,this.dragOffset={x:0,y:0},this.onConnect=t.onConnect||(()=>{}),this.onDisconnect=t.onDisconnect||(()=>{}),this.onViewChange=t.onViewChange||(()=>{}),this.config={lineColor:t.lineColor||"#155BD4",lineWidth:t.lineWidth||2,dotSize:t.dotSize||12,dotColor:t.dotColor||"#155BD4",deleteButtonSize:t.deleteButtonSize||20,enableDelete:!1!==t.enableDelete,enableNodeDrag:!1!==t.enableNodeDrag,snapDistance:t.snapDistance||20,enableSnap:!1!==t.enableSnap,enableZoom:!1!==t.enableZoom,enablePan:!1!==t.enablePan,panOnDragBackground:!1!==t.panOnDragBackground,minZoom:t.minZoom||.1,maxZoom:t.maxZoom||4,zoomStep:t.zoomStep||.1,...t.config},this.snapTarget=null,this.isSnapped=!1,this.viewState={scale:1,translateX:0,translateY:0},this.isPanning=!1,this.panStart={x:0,y:0},this.spacePressed=!1,this.contentWrapper=null,this.init()}init(){if(!this.container)throw Error("Container element is required");let t=window.getComputedStyle(this.container).position;"static"===t&&(this.container.style.position="relative"),this.container.style.overflow="hidden",this.contentWrapper=document.createElement("div"),this.contentWrapper.className="connector-content-wrapper",this.contentWrapper.style.cssText="position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform-origin: 0 0; transition: none;";let e=Array.from(this.container.children);e.forEach(t=>this.contentWrapper.appendChild(t)),this.container.appendChild(this.contentWrapper),this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.style.cssText="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;",this.contentWrapper.appendChild(this.svg),this.config.enableZoom&&this.bindZoomEvents(),this.config.enablePan&&this.bindPanEvents(),this.bindResizeEvents(),this.updateTransform()}updateTransform(){if(!this.contentWrapper)return;let{scale:t,translateX:e,translateY:n}=this.viewState;this.contentWrapper.style.transform=`translate(${e}px, ${n}px) scale(${t})`,this.onViewChange({scale:t,translateX:e,translateY:n})}bindZoomEvents(){this.handleWheel=t=>{if(t.ctrlKey||t.metaKey){t.preventDefault();let e=this.container.getBoundingClientRect(),n=t.clientX-e.left,i=t.clientY-e.top,o=t.deltaY<0?this.config.zoomStep:-this.config.zoomStep,s=Math.max(this.config.minZoom,Math.min(this.config.maxZoom,this.viewState.scale+o));this.zoomAtPoint(s,n,i)}},this.container.addEventListener("wheel",this.handleWheel,{passive:!1})}bindPanEvents(){this.handleKeyDown=t=>{"Space"!==t.code||this.spacePressed||this.isDragging||this.isDraggingNode||(t.preventDefault(),this.spacePressed=!0,this.container.style.cursor="grab")},this.handleKeyUp=t=>{"Space"===t.code&&(this.spacePressed=!1,this.container.style.cursor="",this.isPanning&&this.stopPan())},this.handlePanStart=t=>{let e=this.spacePressed||this.config.panOnDragBackground,n=!t.target.closest(".connector-node")&&!t.target.classList.contains("connector-dot");e&&n&&!this.isDragging&&!this.isDraggingNode&&(t.preventDefault(),t.stopPropagation(),this.isPanning=!0,this.panStart={x:t.clientX-this.viewState.translateX,y:t.clientY-this.viewState.translateY},this.container.style.cursor="grabbing")},this.handlePanMove=t=>{this.isPanning&&(t.preventDefault(),this.viewState.translateX=t.clientX-this.panStart.x,this.viewState.translateY=t.clientY-this.panStart.y,this.updateTransform())},this.handlePanEnd=()=>{this.isPanning&&this.stopPan()},document.addEventListener("keydown",this.handleKeyDown),document.addEventListener("keyup",this.handleKeyUp),this.container.addEventListener("mousedown",this.handlePanStart),this.config.panOnDragBackground&&(this.container.style.cursor="grab"),document.addEventListener("mousemove",this.handlePanMove),document.addEventListener("mouseup",this.handlePanEnd)}stopPan(){this.isPanning=!1,this.container.style.cursor=this.spacePressed?"grab":""}bindResizeEvents(){let t=null;this.handleResize=()=>{t&&clearTimeout(t),t=setTimeout(()=>this.updateAllConnections(),100)},window.addEventListener("resize",this.handleResize),"undefined"!=typeof ResizeObserver&&(this.resizeObserver=new ResizeObserver(()=>{t&&clearTimeout(t),t=setTimeout(()=>this.updateAllConnections(),100)}),this.resizeObserver.observe(this.container))}zoomAtPoint(t,e,n){let i=this.viewState.scale,o=(e-this.viewState.translateX)/i,s=(n-this.viewState.translateY)/i;this.viewState.scale=t,this.viewState.translateX=e-o*t,this.viewState.translateY=n-s*t,this.updateTransform()}setZoom(t){let e=this.container.getBoundingClientRect();this.zoomAtPoint(t,e.width/2,e.height/2)}getZoom(){return this.viewState.scale}resetView(){this.viewState.scale=1,this.viewState.translateX=0,this.viewState.translateY=0,this.updateTransform()}zoomIn(){this.setZoom(Math.min(this.config.maxZoom,this.viewState.scale+this.config.zoomStep))}zoomOut(){this.setZoom(Math.max(this.config.minZoom,this.viewState.scale-this.config.zoomStep))}registerNode(t,e,n={}){if(this.nodes.find(e=>e.id===t))return;let i=[];i="both"===n.dotPositions?["left","right"]:Array.isArray(n.dotPositions)?n.dotPositions.filter(t=>"left"===t||"right"===t):[0===this.nodes.length?"right":"left"],i=[...new Set(i)].slice(0,2);let o={};i.forEach(t=>{let n=this.createDot(t);e.appendChild(n),o[t]={element:n,position:t}}),e.classList.add("connector-node");let s={id:t,element:e,info:n?.info,dots:o,dotPositions:i,connections:[]};return this.nodes.push(s),Object.values(o).forEach(t=>this.bindDotEvents(s,t)),this.config.enableNodeDrag&&this.bindNodeDragEvents(s),s}createDot(t){let e=document.createElement("div");e.className="connector-dot";let n="right"===t?`right: -${this.config.dotSize/2}px;`:`left: -${this.config.dotSize/2}px;`;return e.style.cssText=`position: absolute; width: ${this.config.dotSize}px; height: ${this.config.dotSize}px;background-color: ${this.config.dotColor}; border: 2px solid white; border-radius: 50%;cursor: pointer; ${n} top: 50%; transform: translateY(-50%);z-index: 10; transition: transform 0.2s;`,e.dataset.baseTransform="translateY(-50%)",e.addEventListener("mouseenter",()=>{e.style.transform="translateY(-50%) scale(1.2)"}),e.addEventListener("mouseleave",()=>{e.style.transform="translateY(-50%) scale(1)"}),e}bindDotEvents(t,e){e.element.addEventListener("mousedown",n=>{n.preventDefault(),n.stopPropagation(),this.isDragging=!0,this.startNode=t,this.startDot=e,this.tempLine=this.createLine(),this.svg.appendChild(this.tempLine),this.updateTempLine(n),document.addEventListener("mousemove",this.handleMouseMove),document.addEventListener("mouseup",this.handleMouseUp)})}bindNodeDragEvents(t){t.element.addEventListener("mousedown",e=>{if(e.target.classList.contains("connector-dot")||this.spacePressed)return;e.preventDefault(),e.stopPropagation(),this.isDraggingNode=!0,this.draggedNode=t;let n=t.element.getBoundingClientRect(),i=this.contentWrapper.getBoundingClientRect();this.dragOffset={x:e.clientX-n.left,y:e.clientY-n.top};let o=n.left-i.left,s=n.top-i.top;t.element.style.left=`${o}px`,t.element.style.top=`${s}px`,t.element.style.right="",t.element.style.bottom="",document.addEventListener("mousemove",this.handleNodeDragMove),document.addEventListener("mouseup",this.handleNodeDragEnd)})}handleNodeDragMove=t=>{if(!this.isDraggingNode||!this.draggedNode)return;let e=this.contentWrapper.getBoundingClientRect(),n=t.clientX-e.left-this.dragOffset.x,i=t.clientY-e.top-this.dragOffset.y;this.draggedNode.element.style.left=`${n}px`,this.draggedNode.element.style.top=`${i}px`,this.updateNodeConnections(this.draggedNode.id)};handleNodeDragEnd=()=>{this.isDraggingNode=!1,this.draggedNode=null,document.removeEventListener("mousemove",this.handleNodeDragMove),document.removeEventListener("mouseup",this.handleNodeDragEnd)};handleMouseMove=t=>{this.isDragging&&this.updateTempLine(t)};handleMouseUp=t=>{if(!this.isDragging)return;this.isDragging=!1;let e=this.isSnapped?this.snapTarget:this.getNodeAtPosition(t.clientX,t.clientY),n=this.isSnapped?this.snapTargetDot:null;e&&e.id!==this.startNode.id&&this.createConnection(this.startNode,e,this.startDot,n),this.clearSnapHighlight(),this.snapTarget=null,this.snapTargetDot=null,this.isSnapped=!1,this.startDot=null,this.tempLine&&(this.svg.removeChild(this.tempLine),this.tempLine=null),document.removeEventListener("mousemove",this.handleMouseMove),document.removeEventListener("mouseup",this.handleMouseUp)};updateTempLine(t){if(!this.tempLine||!this.startNode||!this.startDot)return;let e=this.getDotPosition(this.startNode.element,this.startDot.position),n=this.container.getBoundingClientRect(),i=t.clientX-n.left,o=t.clientY-n.top,{scale:s,translateX:a,translateY:r}=this.viewState,d={x:(i-a)/s,y:(o-r)/s};if(this.config.enableSnap){let l=this.checkSnap(d,this.startNode);l?(d=l.position,this.snapTarget=l.node,this.snapTargetDot=l.dot,this.isSnapped=!0,this.highlightSnapTarget(l.node,l.dot)):(this.isSnapped=!1,this.clearSnapHighlight(),this.snapTarget=null,this.snapTargetDot=null)}this.updateLine(this.tempLine,e,d,this.startDot.position)}createConnection(t,e,n=null,i=null,o={}){!n&&t.dots&&(n=t.dots.right||t.dots.left||Object.values(t.dots)[0]),!i&&e.dots&&(i=e.dots.left||e.dots.right||Object.values(e.dots)[0]);let s=this.connections.find(o=>o.fromNode.id===t.id&&o.toNode.id===e.id&&o.fromDot.position===n.position&&o.toDot.position===i.position||o.fromNode.id===e.id&&o.toNode.id===t.id&&o.fromDot.position===i.position&&o.toDot.position===n.position);if(s)return;let a=this.createLine();this.svg.appendChild(a);let r=this.config.enableDelete?this.createDeleteButton():null,d={id:`${t.id}-${e.id}-${n.position}-${i.position}-${Date.now()}`,fromNode:t,toNode:e,fromDot:n,toDot:i,line:a,deleteButton:r};return this.connections.push(d),t.connections.push(d),e.connections.push(d),this.updateConnection(d),this.bindConnectionEvents(d),o.silent||this.onConnect({from:t.id,to:e.id,fromDot:n.position,toDot:i.position}),d}updateConnection(t){if(!t||!t.line)return;let e=this.getDotPosition(t.fromNode.element,t.fromDot.position),n=this.getDotPosition(t.toNode.element,t.toDot.position);if(this.updateLine(t.line,e,n,t.fromDot.position,t.toDot.position),t.hoverPath&&this.updateLine(t.hoverPath,e,n,t.fromDot.position,t.toDot.position),t.deleteButton){let i=this.getBezierMidPoint(e,n,t.fromDot.position,t.toDot.position);t.deleteButton.style.left=`${i.x-this.config.deleteButtonSize/2}px`,t.deleteButton.style.top=`${i.y-this.config.deleteButtonSize/2}px`}}updateNodeConnections(t){let e=this.connections.filter(e=>e.fromNode.id===t||e.toNode.id===t);e.forEach(t=>this.updateConnection(t))}updateAllConnections(){this.connections.forEach(t=>this.updateConnection(t))}createLine(){let t=document.createElementNS("http://www.w3.org/2000/svg","path");return t.setAttribute("stroke",this.config.lineColor),t.setAttribute("stroke-width",this.config.lineWidth),t.setAttribute("fill","none"),t}updateLine(t,e,n,i="right",o="left"){let s=n.x-e.x,a=n.y-e.y,r=Math.min(.5*Math.sqrt(s*s+a*a),150),d="right"===i?e.x+r:e.x-r,l="right"===o?n.x+r:n.x-r,h=`M ${e.x} ${e.y} C ${d} ${e.y}, ${l} ${n.y}, ${n.x} ${n.y}`;t.setAttribute("d",h)}getBezierMidPoint(t,e,n="right",i="left"){let o=e.x-t.x,s=e.y-t.y,a=Math.min(.5*Math.sqrt(o*o+s*s),150),r="right"===n?t.x+a:t.x-a,d=t.y,l="right"===i?e.x+a:e.x-a,h=e.y,c=.25,p=.5*c,g=.125,m=p*t.x+3*c*.5*r+.375*l+g*e.x,u=p*t.y+3*c*.5*d+.375*h+g*e.y;return{x:m,y:u}}createDeleteButton(){let t=document.createElement("div");return t.className="connector-delete-btn",t.innerHTML="\xd7",t.style.cssText=`position: absolute; width: ${this.config.deleteButtonSize}px; height: ${this.config.deleteButtonSize}px;background-color: #ff0055; color: white; border-radius: 50%; display: flex; align-items: center;justify-content: center; cursor: pointer; font-size: 16px; font-weight: bold; z-index: 100;opacity: 0; transition: opacity 0.2s, transform 0.2s; pointer-events: none;`,this.contentWrapper.appendChild(t),t.addEventListener("mouseenter",()=>t.style.transform="scale(1.2)"),t.addEventListener("mouseleave",()=>{t.style.transform="scale(1)",t.style.opacity="0",t.style.pointerEvents="none"}),t}bindConnectionEvents(t){let{line:e,deleteButton:n}=t;if(!n){e.style.pointerEvents="none";return}e.style.pointerEvents="stroke",e.style.cursor="pointer";let i=document.createElementNS("http://www.w3.org/2000/svg","path");i.setAttribute("stroke","transparent"),i.setAttribute("stroke-width","20"),i.setAttribute("fill","none"),i.style.pointerEvents="stroke",i.style.cursor="pointer",i.setAttribute("d",e.getAttribute("d")),this.svg.insertBefore(i,e),t.hoverPath=i;let o=()=>{n.style.opacity="1",n.style.pointerEvents="auto"},s=()=>{setTimeout(()=>{n.matches(":hover")||(n.style.opacity="0",n.style.pointerEvents="none")},100)};i.addEventListener("mouseenter",o),i.addEventListener("mouseleave",s),e.addEventListener("mouseenter",o),e.addEventListener("mouseleave",s),n.addEventListener("click",()=>this.disconnect(t.id))}disconnect(t,e={}){if(t){let n=this.connections.findIndex(e=>e.id===t);if(-1===n)return;let i=this.connections[n];i.line?.parentNode&&this.svg.removeChild(i.line),i.hoverPath?.parentNode&&this.svg.removeChild(i.hoverPath),i.deleteButton?.parentNode&&i.deleteButton.parentNode.removeChild(i.deleteButton),i.fromNode.connections=i.fromNode.connections.filter(e=>e.id!==t),i.toNode.connections=i.toNode.connections.filter(e=>e.id!==t),this.connections.splice(n,1),e.silent||this.onDisconnect({from:i.fromNode.id,to:i.toNode.id})}else[...this.connections].forEach(t=>this.disconnect(t.id,e))}getDotPosition(t,e){let n=t.getBoundingClientRect(),i=this.container.getBoundingClientRect(),o="right"===e?n.right-i.left:n.left-i.left,s=n.top+n.height/2-i.top,{scale:a,translateX:r,translateY:d}=this.viewState;return{x:(o-r)/a,y:(s-d)/a}}getNodeAtPosition(t,e){for(let n of this.nodes){let i=n.element.getBoundingClientRect();if(t>=i.left&&t<=i.right&&e>=i.top&&e<=i.bottom)return n}return null}checkSnap(t,e){if(!this.config.enableSnap)return null;let n={node:null,dot:null,dist:1/0};for(let i of this.nodes)i.id!==e.id&&i.dots&&Object.values(i.dots).forEach(e=>{let o=this.getDotPosition(i.element,e.position),s=Math.sqrt(Math.pow(t.x-o.x,2)+Math.pow(t.y-o.y,2));s<this.config.snapDistance&&s<n.dist&&(n={node:i,dot:e,dist:s})});return n.node?{node:n.node,dot:n.dot,position:this.getDotPosition(n.node.element,n.dot.position)}:null}highlightSnapTarget(t,e){t?.element&&(this.clearSnapHighlight(),t.element.style.boxShadow="0 0 0 2px rgba(0, 229, 255, 0.5)",t.element.dataset.snapped="true",e?.element&&(e.element.style.transform=(e.element.dataset.baseTransform||"")+" scale(1.5)",e.element.style.boxShadow="0 0 10px rgba(0, 229, 255, 0.8)",e.element.dataset.highlighted="true"))}clearSnapHighlight(){this.nodes.forEach(t=>{t.element.dataset.snapped&&(t.element.style.boxShadow="",delete t.element.dataset.snapped,Object.values(t.dots||{}).forEach(t=>{t.element.dataset.highlighted&&(t.element.style.transform=t.element.dataset.baseTransform||"",t.element.style.boxShadow="",delete t.element.dataset.highlighted)}))})}}function e(t,e,n){if(!t)return;let i=document.createElement("div");i.className=`log-entry ${n||"info"}`;let o=new Date().toLocaleTimeString([],{hour12:!1});i.textContent=`[${o}] ${e}`,t.prepend(i),t.children.length>20&&t.lastElementChild.remove()}document.addEventListener("DOMContentLoaded",()=>{let n=document.getElementById("canvas-container");if(!n)return;let i=document.getElementById("log-container"),o=document.getElementById("zoom-display"),s=new t({container:n,lineColor:"#cbb38e",lineWidth:2.5,dotSize:12,dotColor:"#9fc7c0",deleteButtonSize:22,enableNodeDrag:!0,enableSnap:!0,snapDistance:36,onConnect:t=>e(i,`Connected: ${t.from} → ${t.to}`,"success"),onDisconnect:t=>e(i,`Disconnected: ${t.from} → ${t.to}`,"warn"),onViewChange(t){o&&(o.textContent=`Zoom: ${Math.round(100*t.scale)}%`)}}),a=document.getElementById("node1"),r=document.getElementById("node2"),d=document.getElementById("node3"),l=document.getElementById("node4");a&&s.registerNode("node1",a,{dotPositions:["right"]}),r&&s.registerNode("node2",r,{dotPositions:["left","right"]}),d&&s.registerNode("node3",d,{dotPositions:["left","right"]}),l&&s.registerNode("node4",l,{dotPositions:["left"]});let h=()=>{s.disconnect();let t=s.nodes.find(t=>"node1"===t.id),n=s.nodes.find(t=>"node2"===t.id),o=s.nodes.find(t=>"node3"===t.id),a=s.nodes.find(t=>"node4"===t.id);t&&n&&s.createConnection(t,n),t&&o&&s.createConnection(t,o),n&&a&&s.createConnection(n,a),o&&a&&s.createConnection(o,a),e(i,"Auto-connected demo layout","info")},c=document.getElementById("flowAutoConnect"),p=document.getElementById("flowClear"),g=document.getElementById("flowZoomIn"),m=document.getElementById("flowZoomOut"),u=document.getElementById("flowReset");c&&c.addEventListener("click",h),p&&p.addEventListener("click",()=>{s.disconnect(),e(i,"All connections removed","error")}),g&&g.addEventListener("click",()=>s.zoomIn()),m&&m.addEventListener("click",()=>s.zoomOut()),u&&u.addEventListener("click",()=>s.resetView()),setTimeout(h,300)}),window.PowerLinkConnector=t}();