/*
✨ CoonDev • https://dev.coonlink.com/

 ▄█▄    ████▄ ████▄    ▄   ██▄   ▄███▄      ▄
 █▀ ▀▄  █   █ █   █     █  █  █  █▀   ▀      █
 █   ▀  █   █ █   █ ██   █ █   █ ██▄▄   █     █
 █▄  ▄▀ ▀████ ▀████ █ █  █ █  █  █▄   ▄▀ █    █
 ▀███▀              █  █ █ ███▀  ▀███▀    █  █
                    █   ██                 █▐
                                           ▐
*/

function scope(){function e(){chrome.runtime.sendMessage({type:"getFullRefresh"})}function t(){chrome.runtime.sendMessage({type:"onPopupOpen"})}function n(e){function t(e){return $-1-e}if(se){var n=1e3/30-(performance.now()-se);if(n>0)return void setTimeout(r,n)}if(se=performance.now(),ie&&ie.remove(),l()){var a=e.fft;if(oe&&a.length>0){strokeGradient=oe.gradient("l(.5, 0, .5, 1)"+H+"-"+K);var o=[];for(var i in a){var s=i*A/(2*a.length);if(!(10>s)){var c=y(s);if(c>X)break;var u=(a[i]+100)/100*$;o.push([c,u])}}var d=[];for(var i in o){var f=o[i];if(0!=d.length){var g=d[d.length-1],v=2;f[0]-g[0]<v?f[1]>g[1]&&(g[1]=f[1]):d.push(f)}else d.push(f)}var p=[];for(var i in d){var g=d[i];p=p.concat([g[0],t(g[1])])}ie=oe.polyline(p).attr({"fill-opacity":"0",stroke:strokeGradient,"pointer-events":"none"})}r()}}function r(){chrome.runtime.sendMessage({type:"getFFT"},n)}function a(e){for(var t=e.presets,n=document.getElementById("userPresetSpan");n.firstChild;)n.removeChild(n.firstChild);for(var r=Object.keys(t),a=0;a<r.length;a++)!function(e){var t=document.createElement("button");t.textContent=e,n.appendChild(t),t.onclick=function(){chrome.runtime.sendMessage({type:"preset",preset:e}),document.getElementById("presetNameInput").value=e}}(r[a])}function o(){chrome.runtime.sendMessage({type:"eqTab",on:!0})}function i(){var e=document.getElementById("eqTabButton");e.onclick=function(){o()},e.textContent="EQ This Tab"}function s(){var e=document.getElementById("eqTabButton");e.onclick=function(){chrome.runtime.sendMessage({type:"eqTab",on:!1})},e.textContent="Stop EQing This Tab"}function l(){return 1==localStorage[U]}function c(){J||(R[U]^=!0,l()&&r())}function u(e){W=[];for(var t=0;t<e.eqFilters.length;t++){var n=e.eqFilters[t],r={};r.x=y(n.frequency),r.y=b(n.gain),n.frequency/n.q,r.w=n.frequency/n.q,r.t=n.type,r.gain=n.gain,r.q=n.q,r.frequency=n.frequency,W.push(r)}var a={};a.gain=e.gain,a.y=b(I(a.gain)),v(W,a),d(e.streams)}function d(e){var t=document.getElementById("eqTabList"),n=document.getElementById("tabsGraph");if(n&&window.PowerLinkConnector)return t&&t.classList.add("graph-hidden"),n.classList.add("graph-ready"),f(n,e),void 0;if(t.innerHTML="",0==e.length)return void(t.textContent="No tabs active. Click 'EQ This Tab' below to activate this tab.");for(var r=document.createElement("table"),a=0;a<e.length;a++)r.appendChild(g(e[a]));t.appendChild(r)}function f(e,t){function n(e,t,n){return Math.max(t,Math.min(n,e))}function r(e,t){if(e)for(var n=e.querySelectorAll(".tab-node"),r=0;r<n.length;r++){var a=n[r],o=a.dataset.nodeId;if(o){var i=parseFloat(a.style.left),s=parseFloat(a.style.top);isNaN(i)||isNaN(s)||(t[o]={x:i,y:s})}}}function a(e){try{localStorage.TABS_GRAPH_POS_V1=JSON.stringify(e)}catch(t){}}function o(e){return{x:n(e.x,w,Math.max(w,S-q-w)),y:n(e.y,w,Math.max(w,b-E-w))}}function i(e){x.push({x:e.x+q/2,y:e.y+E/2})}function s(e){for(var t=0;t<x.length;t++){var n=x[t],r=e.x+q/2-n.x,a=e.y+E/2-n.y;if(Math.sqrt(r*r+a*a)<k)return!0}return!1}function l(e){for(var t=0;120>t;t++){var n=e+t,r=2.3999632297*n,a=Math.max(120,.25*Math.min(S,b))+55*Math.sqrt(n),i=M.x+Math.cos(r)*a,l=M.y+Math.sin(r)*a,c=o({x:i,y:l});if(!s(c))return c}return o({x:M.x+60,y:M.y+30})}if(window.PowerLinkConnector){window.__tabsGraphState||(window.__tabsGraphState={connector:null,positions:{},loaded:!1,boundSave:!1,container:null});var c=window.__tabsGraphState,u=c.connector;if(c.boundSave||(c.boundSave=!0,document.addEventListener("mouseup",function(){setTimeout(function(){var e=window.__tabsGraphState;if(e&&e.connector&&e.container&&!e.connector.isDraggingNode&&!e.connector.isDragging){var t=e.connector.contentWrapper;t&&(r(t,e.positions),a(e.positions))}},0)})),!c.loaded){c.loaded=!0;try{var d=localStorage.TABS_GRAPH_POS_V1;d&&(c.positions=JSON.parse(d)||{})}catch(f){c.positions={}}}if(!u||!u.isDraggingNode&&!u.isDragging){if(!t||0==t.length)return void(e.innerHTML='<div class="tabs-empty">No tabs active. Click "EQ This Tab" below to activate this tab.</div>');if(u&&u.contentWrapper&&r(u.contentWrapper,c.positions),u&&c.container===e){u.disconnect(),u.nodes=[],u.connections=[];var g=u.contentWrapper,v=u.svg;g&&v&&(g.innerHTML="",g.appendChild(v))}else e.innerHTML="",u=new window.PowerLinkConnector({container:e,lineColor:"#cbb38e",lineWidth:2.5,dotSize:12,dotColor:"#9fc7c0",deleteButtonSize:20,enableDelete:!1,enableNodeDrag:!0,enableSnap:!0,enablePan:!0,panOnDragBackground:!0,snapDistance:36}),c.connector=u,c.container=e;var p=u.contentWrapper||e,m=c.positions,y="__hub__",h=(u.container||e).getBoundingClientRect(),S=h.width||600,b=h.height||260,w=20,q=200,E=70,k=160,M=m[y]?o(m[y]):{x:Math.max(w,.45*S-q/2),y:Math.max(w,.45*b-E/2)};m[y]=M;for(var x=[],C=0;C<t.length;C++){var N="tab-"+t[C].id;m[N]&&(m[N]=o(m[N]),i(m[N]))}i(M);var O=document.createElement("div");O.className="tab-node hub",O.dataset.nodeId=y,O.textContent="Ears Engine",O.style.left=M.x+"px",O.style.top=M.y+"px",p.appendChild(O),u.registerNode(y,O,{dotPositions:["left","right"]}),O.addEventListener("mouseup",function(){m[y]={x:parseFloat(O.style.left)||0,y:parseFloat(O.style.top)||0},a(m)});for(var T=u.nodes.find(function(e){return e.id===y}),P=0;P<t.length;P++){var I=t[P],F="tab-"+I.id,L=m[F]?m[F]:l(P);m[F]=L,i(L);var B=document.createElement("div");B.className="tab-node",B.dataset.nodeId=F,B.style.left=L.x+"px",B.style.top=L.y+"px";var R=document.createElement("button");R.textContent="Stop EQing",R.onclick=function(e){return function(){chrome.runtime.sendMessage({type:"disconnectTab",tab:e})}}(I);var J=document.createElement("div");J.className="tab-title";var A=document.createElement("img");A.className="tabFavIcon",A.alt="",I.favIconUrl&&(A.src=I.favIconUrl),J.appendChild(A);var _=document.createElement("span");_.textContent=I.title||"(untitled)",J.appendChild(_),B.appendChild(R),B.appendChild(J),p.appendChild(B),u.registerNode(F,B,{dotPositions:["left","right"]}),B.addEventListener("mouseup",function(e,t){return function(){m[e]={x:parseFloat(t.style.left)||0,y:parseFloat(t.style.top)||0},a(m)}}(F,B)),T&&u.createConnection(T,u.nodes.find(function(e){return e.id===F}))}for(var Q in m)y!==Q&&!t.some(function(e){return"tab-"+e.id===Q})&&delete m[Q];a(m)}}}function g(e){var t=document.createElement("tr"),n=document.createElement("button");n.textContent="Stop EQing",n.onclick=function(){chrome.runtime.sendMessage({type:"disconnectTab",tab:e})};var r=document.createElement("img");r.className="tabFavIcon",r.src=e.favIconUrl,r.alt="",n.appendChild(r);var a=document.createElement("td");a.appendChild(n),t.appendChild(a);var o=document.createElement("td"),i=e.title;return i.length>45&&(i=i.substring(0,45)),o.textContent=i,t.appendChild(o),t}function v(e,t){oe&&oe.clear(),le&&le.clear(),oe=Snap("#eqSvg"),oe.attr({fill:K,height:$,width:X}),le=Snap("#gainSvg"),le.attr({fill:K,height:$,width:ee});var n={fill:H,stroke:H};oe.rect(0,0,X,$).attr({stroke:"#e6e1d6100"}),k(oe,e),M(oe);var r=(le.line(ee/2,b(ae),ee/2,b(re)).attr({stroke:z,opacity:.5}),le.text(ee/2,b(re)-10,"volume").attr({fill:V,"text-anchor":"middle","font-size":8}),le.line(ee/2-5,b(0),ee/2+5,b(0)).attr({stroke:z}),le.line(0,t.y,ee,t.y).attr({stroke:V}).addClass("gainLine"));r.drag(C(r),ue,N(r));for(var a=0;a<e.length;a++){var o=e[a],i=o.x,s=o.y,l=n;"peaking"==o.t&&(l={fill:Z,stroke:Z}),("highshelf"==o.t||"lowshelf"==o.t)&&(l={fill:Y,stroke:Y});var c=oe.circle(i,s,4).attr(l).addClass("filterDot");c.drag(O(o,a,oe),ue,B(o,a)),c.dblclick(p(o,a))}}function p(t,n){return function(){t.gain=0,t.y=b(0),L(n),e()}}function m(e){return S(e/X)*te}function y(e){return h(e/te)*X}function h(e){return Math.pow(e,.25)}function S(e){return Math.pow(e,4)}function b(e){var t=ne-ae;return $*(1-(e-ae)/t)}function w(e){var t=ne-ae;return(1-e/$)*t+ae}function q(e){var t=e.node.getClientRects()[0];return[t.left,t.top]}function E(e,t,n){var r=t.frequency,a=t.q,o=t.gain,i=Math.tan(Math.PI*r/A),s=1/(1+1/a*i+i*i),l=Math.pow(10,Math.abs(o)/20),c=0,u=0,d=0,f=0,g=0,v=p;"peaking"==t.t?(v=Z,o>=0?(s=1/(1+1/a*i+i*i),c=(1+l/a*i+i*i)*s,u=2*(i*i-1)*s,d=(1-l/a*i+i*i)*s,f=u,g=(1-1/a*i+i*i)*s):(s=1/(1+l/a*i+i*i),c=(1+1/a*i+i*i)*s,u=2*(i*i-1)*s,d=(1-Math.abs(l)/a*i+i*i)*s,f=u,g=(1-l/a*i+i*i)*s)):"highshelf"==t.t?(v=Y,o>=0?(s=1/(1+Math.SQRT2*i+i*i),c=(l+Math.sqrt(2*l)*i+i*i)*s,u=2*(i*i-l)*s,d=(l-Math.sqrt(2*l)*i+i*i)*s,f=2*(i*i-1)*s,g=(1-Math.SQRT2*i+i*i)*s):(s=1/(l+Math.sqrt(2*l)*i+i*i),c=(1+Math.SQRT2*i+i*i)*s,u=2*(i*i-1)*s,d=(1-Math.SQRT2*i+i*i)*s,f=2*(i*i-l)*s,g=(l-Math.sqrt(2*l)*i+i*i)*s)):"lowshelf"==t.t&&(v=Y,o>=0?(s=1/(1+Math.SQRT2*i+i*i),c=(1+Math.sqrt(2*l)*i+l*i*i)*s,u=2*(l*i*i-1)*s,d=(1-Math.sqrt(2*l)*i+l*i*i)*s,f=2*(i*i-1)*s,g=(1-Math.SQRT2*i+i*i)*s):(s=1/(1+Math.sqrt(2*l)*i+l*i*i),c=(1+Math.SQRT2*i+i*i)*s,u=2*(i*i-1)*s,d=(1-Math.SQRT2*i+i*i)*s,f=2*(l*i*i-1)*s,g=(1-Math.sqrt(2*l)*i+l*i*i)*s));var p=[],m=window.__eqFreqCache;if(!m||m.width!==X||m.sampleRate!==A){for(var y=new Float32Array(Math.ceil(X/2)),h=0,w=0;X>h;h+=2,w++)y[w]=S(h/X)*te;m={freqs:y,width:X,sampleRate:A},window.__eqFreqCache=m}var q=window.__eqAudioCtx;if(!q||q.sampleRate!==A){try{q=new(window.OfflineAudioContext||window.webkitOfflineAudioContext)(1,1,A)}catch(w){q=null}window.__eqAudioCtx=q,window.__eqBiquadNode=null}var E=null;if(q&&q.createBiquadFilter&&(E=window.__eqBiquadNode,E&&E.context!==q&&(E=null),E||(E=q.createBiquadFilter()),window.__eqBiquadNode=E),E&&E.getFrequencyResponse){E.type=t.t,E.frequency.value=r,E.Q.value=a,E.gain.value=o;for(var k=new Float32Array(m.freqs.length),M=new Float32Array(m.freqs.length),x=0;x<m.freqs.length;x++)k[x]=0,M[x]=0;E.getFrequencyResponse(m.freqs,k,M);for(var C=0,N=0;X>C;C+=2,N++){var O=k[N];O>0||(O=1e-12),O=20*Math.log(O)/Math.LN10,ae>O&&(O=ae),O>ne&&(O=ne),O=b(O),isFinite(O)&&(p=p.concat([C,O]))}}else for(var C=0;X>C;C+=2){var y=S(C/X)*Math.PI,h=Math.pow(Math.sin(y/2),2),w=(Math.pow(c+u+d,2)-4*(c*u+4*c*d+u*d)*h+16*c*d*h*h)/(Math.pow(1+f+g,2)-4*(f+4*g+f*g)*h+16*g*h*h);(!isFinite(w)||0>=w)&&(w=1e-12),w=10*Math.log(w)/Math.LN10,ae>w&&(w=ae),w>ne&&(w=ne),w=b(w),isFinite(w)&&(p=p.concat([C,w]))}var T=null;T=o>=0?e.gradient("l(.5, 0, .5, 1)"+v+"-"+K):e.gradient("l(.5, 1, .5, 0)"+v+"-"+K),ce[n]&&ce[n].remove(),ce[n]=e.polyline(p).attr({stroke:T,"fill-opacity":"0","pointer-events":"none"})}function k(e,t){for(var n=0;n<t.length;n++){var r=t[n];E(e,r,n)}}function M(e){for(var t=5;te>t;t*=2){var n=y(t);e.line(n,$/2+10,n,$/2-10).attr({stroke:z,"stroke-opacity":.25}),e.line(n,$,n,$-15).attr({stroke:z}),e.text(n,$-18,""+Math.round(m(n))).attr({fill:V,"text-anchor":"middle","font-size":10}),e.line(n,0,n,15).attr({stroke:z})}for(var r=5,a=ae;ne>a;a+=r){var o=b(a);Math.abs(ne)-Math.abs(a)>r/2&&(e.line(0,o,5,o).attr({stroke:z}),e.text(7,o,""+a).attr({fill:V,"font-size":10,"dominant-baseline":"middle"}))}}function x(e){return.2>e&&(e=.2),e>11&&(e=11),e}function C(e){return function(t,n,r,a,o){var i=q(le);a-=i[1],0>a||a>=$||(w(a)>re&&(n-=a-b(re),a=b(re)),e.y=a,e.gain=P(w(a)),this.attr({transform:this.data("origTransform")+(this.data("origTransform")?"T":"t")+[0,n]}),F(e))}}function N(t){return function(){this.attr({fill:K}),chrome.runtime.sendMessage({type:"gainUpdated",gain:t.gain}),e()}}function O(e,t,n){return function(r,a,o,i,s){if(s.shiftKey)e.q=x(e.q+s.movementY/10);else{var l=q(oe);if(o-=l[0],i-=l[1],0>o||o>=X||0>i||i>=$)return;e.x=o,e.y=i,e.gain=w(i),e.frequency=m(o),this.attr({transform:this.data("origTransform")+(this.data("origTransform")?"T":"t")+[r,a]})}E(n,e,t),T(e,t)}}function T(e,t){chrome.runtime.sendMessage({type:"modifyFilter",index:t,frequency:m(e.x),gain:w(e.y),q:e.q})}function P(e){return Math.pow(10,e/10)}function I(e){return 10*Math.log10(e)}function F(e){chrome.runtime.sendMessage({type:"modifyGain",gain:e.gain})}function L(e){chrome.runtime.sendMessage({type:"resetFilter",index:e})}function B(t,n){return function(){this.attr({fill:K}),chrome.runtime.sendMessage({type:"filterUpdated",filterType:t.t,frequency:t.frequency,gain:t.gain,q:t.q}),e()}}var R=(chrome.runtime.getManifest().version,localStorage),J=null;document.addEventListener("DOMContentLoaded",function(n){t(),e(),o()}),document.addEventListener("DOMContentLoaded",function(){function e(e){o.textContent=e,o.classList.add("show"),setTimeout(function(){o.classList.remove("show")},5e3)}function t(){l()?d.classList.add("on"):d.classList.remove("on")}var n=document.getElementById("presetNameInput"),r=document.getElementById("resetFiltersButton");r.onclick=function(){n.value="",chrome.runtime.sendMessage({type:"resetFilters"})};var a=document.getElementById("bassBoostButton");a.onclick=function(){n.value="",chrome.runtime.sendMessage({type:"preset",preset:"bassBoost"})};var o=document.getElementById("requiresProDiv"),i=document.getElementById("savePresetButton");i.onclick=function(){if(J&&userPresetSpan.children.length>=J+1)return void e("Saving more than 3 presets requires Ears Pro. Click the Pro tab above to start your free trial!");var t=n.value.trim();""!=t?chrome.runtime.sendMessage({type:"savePreset",preset:t}):(e("Type a name in the Preset Name box, then click Save Preset or press Enter."),n.focus())};var s=document.getElementById("deletePresetButton");s.onclick=function(){var e=n.value.trim();""!=e&&chrome.runtime.sendMessage({type:"deletePreset",preset:e})},n.onkeypress=function(e){e||(e=window.event);var t=e.keyCode||e.which;return"13"==t&&document.activeElement==n?(i.click(),!1):void 0};var u=document.getElementById("openPresetsPanelButton");u&&(u.onclick=function(){var e=chrome.runtime.getURL("views/presets.html");return chrome.sidePanel&&chrome.sidePanel.open?void chrome.windows.getCurrent(function(t){try{chrome.sidePanel.open({windowId:t.id})}catch(n){window.open(e)}}):void window.open(e)});var d=document.getElementById("vizButton");t(),d.onclick=function(){J&&e("The frequency spectrum visualizer requires Ears Pro. Click the Pro tab above to start your free trial!"),c(),t()};for(var f=["tab-1","tab-2","tab-3"],g=0;g<f.length;g++){var v=f[g];document.getElementById(v).addEventListener("change",function(e){return function(){this.checked&&(localStorage["last-tab"]=e)}}(v))}var p=localStorage["last-tab"];if(p){var m=document.getElementById(p);m&&m.click()}window.innerWidth&&window.innerWidth>1e3&&(document.getElementById("fullscreen-link").style.display="none")});var A=44100,_="eqSvg",Q="eqTabButton",j="How was your day of beautiful audio? Let us know what you think at the link below! If you would like to continue using Ears, please support us by making a purchase. If you have already purchased Ears, please restart Chrome. Enjoy!",G=!0,D=function(){G&&(e(),setTimeout(D,1e3))};setTimeout(D,1e3),chrome.runtime.onMessage.addListener(function(e,t,n){if("sendCurrentTabStatus"==e.type&&(e.streaming?s():i()),"sendWorkspaceStatus"==e.type&&(G=!1,u(e)),"sendSampleRate"==e.type&&(A=e.Fs,console.log("set sample rate to "+A)),"sendPresets"==e.type&&a(e),"F"==e.type){var r=document.getElementById(_);r&&r.remove();var o=document.getElementById(Q);o&&o.remove(),document.getElementById("lt").textContent=j,document.getElementById("pl").style.display="block"}});var U="SHOW_VISUALIZER",W=[],H="rgba(230, 225, 214, 0.55)",z="rgba(230, 225, 214, 0.5)",V="rgba(230, 225, 214, 0.65)",K="#29313B",Y="#9573A8",Z="#CDF7E1",X=670,$=303,ee=30,te=22050,ne=30,re=10,ae=-30,oe=null,ie=null,se=null,le=null,ce={},ue=function(){this.data("origTransform",this.transform().local),this.attr({fill:"black"})};l()&&r()}!function(){scope()}(),document.addEventListener("DOMContentLoaded",function(){function e(){o.paused||o.ended?a.classList.remove("is-playing"):a.classList.add("is-playing"),document.fullscreenElement===a?a.classList.add("is-fullscreen"):a.classList.remove("is-fullscreen"),o.muted||0===o.volume?(a.classList.add("is-muted"),a.classList.remove("is-low")):o.volume<=.4?(a.classList.remove("is-muted"),a.classList.add("is-low")):(a.classList.remove("is-muted"),a.classList.remove("is-low")),v&&document.activeElement!==v&&(v.value=o.muted?0:o.volume)}function t(){o.paused?o.play():o.pause()}function n(){o.muted=!o.muted,o.muted||0!==o.volume||(o.volume=.8),e()}function r(){document.fullscreenElement===a?document.exitFullscreen():a.requestFullscreen&&a.requestFullscreen()}var a=document.getElementById("demoPlayer"),o=document.getElementById("demoVideo");if(a&&o){var i=a.querySelector('[data-action="play"]'),s=a.querySelector('[data-action="pause"]'),l=a.querySelector('[data-action="expand"]'),c=a.querySelector('[data-action="compress"]'),u=a.querySelector('[data-action="volume"]'),d=a.querySelector('[data-action="volume-low"]'),f=a.querySelector('[data-action="volume-off"]'),g=a.querySelector('[data-action="volume-xmark"]'),v=a.querySelector(".volume-slider");i&&i.addEventListener("click",t),s&&s.addEventListener("click",t),l&&l.addEventListener("click",r),c&&c.addEventListener("click",r),u&&u.addEventListener("click",n),d&&d.addEventListener("click",n),f&&f.addEventListener("click",n),g&&g.addEventListener("click",n),v&&v.addEventListener("input",function(t){var n=parseFloat(t.target.value);isNaN(n)||(o.volume=n,o.muted=0===n,e())}),o.addEventListener("play",e),o.addEventListener("pause",e),o.addEventListener("volumechange",e),document.addEventListener("fullscreenchange",e),e()}});