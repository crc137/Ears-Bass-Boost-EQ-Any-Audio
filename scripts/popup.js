/*
✨ CoonDev • https://dev.coonlink.com/

 ▄█▄    ████▄ ████▄    ▄   ██▄   ▄███▄      ▄
 █▀ ▀▄  █   █ █   █     █  █  █  █▀   ▀      █
 █   ▀  █   █ █   █ ██   █ █   █ ██▄▄   █     █
 █▄  ▄▀ ▀████ ▀████ █ █  █ █  █  █▄   ▄▀ █    █
 ▀███▀              █  █ █ ███▀  ▀███▀    █  █
                    █   ██                 █▐
                                           ▐
*/

function scope(){function e(){chrome.runtime.sendMessage({type:"getFullRefresh"})}function t(){chrome.runtime.sendMessage({type:"onPopupOpen"})}function n(e){function t(e){return X-1-e}if(ie){var n=1e3/30-(performance.now()-ie);if(n>0)return void setTimeout(r,n)}if(ie=performance.now(),oe&&oe.remove(),c()){var a=e.fft;if(ae&&a.length>0){strokeGradient=ae.gradient("l(.5, 0, .5, 1)"+j+"-"+K);var o=[];for(var i in a){var s=i*O/(2*a.length);if(!(10>s)){var l=g(s);if(l>_)break;var u=(a[i]+100)/100*X;o.push([l,u])}}var d=[];for(var i in o){var m=o[i];if(0!=d.length){var f=d[d.length-1],v=2;m[0]-f[0]<v?m[1]>f[1]&&(f[1]=m[1]):d.push(m)}else d.push(m)}var h=[];for(var i in d){var f=d[i];h=h.concat([f[0],t(f[1])])}oe=ae.polyline(h).attr({"fill-opacity":"0",stroke:strokeGradient,"pointer-events":"none"})}r()}}function r(){chrome.runtime.sendMessage({type:"getFFT"},n)}function a(e){for(var t=e.presets,n=document.getElementById("userPresetSpan");n.firstChild;)n.removeChild(n.firstChild);for(var r=Object.keys(t),a=0;a<r.length;a++)!function(e){var t=document.createElement("button");t.textContent=e,n.appendChild(t),t.onclick=function(){chrome.runtime.sendMessage({type:"preset",preset:e}),document.getElementById("presetNameInput").value=e}}(r[a])}function o(){chrome.runtime.sendMessage({type:"eqTab",on:!0})}function i(){var e=document.getElementById("eqTabButton");e.onclick=function(){o()},e.textContent="EQ This Tab"}function s(){var e=document.getElementById("eqTabButton");e.onclick=function(){chrome.runtime.sendMessage({type:"eqTab",on:!1})},e.textContent="Stop EQing This Tab"}function c(){return 1==localStorage[G]}function l(){N||(Q[G]^=!0,c()&&r())}function u(e){H=[];for(var t=0;t<e.eqFilters.length;t++){var n=e.eqFilters[t],r={};r.x=g(n.frequency),r.y=E(n.gain);n.frequency/n.q;r.w=n.frequency/n.q,r.t=n.type,r.gain=n.gain,r.q=n.q,r.frequency=n.frequency,H.push(r)}var a={};a.gain=e.gain,a.y=E(x(a.gain)),f(H,a),d(e.streams)}function d(e){var t=document.getElementById("eqTabList");if(t.innerHTML="",0==e.length)return void(t.textContent="No tabs active. Click 'EQ This Tab' below to activate this tab.");for(var n=document.createElement("table"),r=0;r<e.length;r++)n.appendChild(m(e[r]));t.appendChild(n)}function m(e){var t=document.createElement("tr"),n=document.createElement("button");n.textContent="Stop EQing",n.onclick=function(){chrome.runtime.sendMessage({type:"disconnectTab",tab:e})};var r=document.createElement("img");r.className="tabFavIcon",r.src=e.favIconUrl,r.alt="",n.appendChild(r);var a=document.createElement("td");a.appendChild(n),t.appendChild(a);var o=document.createElement("td"),i=e.title;return i.length>45&&(i=i.substring(0,45)),o.textContent=i,t.appendChild(o),t}function f(e,t){ae&&ae.clear(),se&&se.clear(),ae=Snap("#eqSvg"),ae.attr({fill:K,height:X,width:_}),se=Snap("#gainSvg"),se.attr({fill:K,height:X,width:$});var n={fill:j,stroke:j};ae.rect(0,0,_,X).attr({stroke:"#e6e1d6100"});b(ae,e),L(ae);var r=(se.line($/2,E(re),$/2,E(ne)).attr({stroke:V,opacity:.5}),se.text($/2,E(ne)-10,"volume").attr({fill:J,"text-anchor":"middle","font-size":8}),se.line($/2-5,E(0),$/2+5,E(0)).attr({stroke:V}),se.line(0,t.y,$,t.y).attr({stroke:J}).addClass("gainLine"));r.drag(S(r),le,B(r));for(var a=0;a<e.length;a++){var o=e[a],i=o.x,s=o.y,c=n;"peaking"==o.t&&(c={fill:Z,stroke:Z}),("highshelf"==o.t||"lowshelf"==o.t)&&(c={fill:Y,stroke:Y});var l=ae.circle(i,s,4).attr(c).addClass("filterDot");l.drag(w(o,a,ae),le,R(o,a)),l.dblclick(v(o,a))}}function v(t,n){return function(){t.gain=0,t.y=E(0),F(n),e()}}function h(e){return y(e/_)*ee}function g(e){return p(e/ee)*_}function p(e){return Math.pow(e,.25)}function y(e){return Math.pow(e,4)}function E(e){var t=te-re;return X*(1-(e-re)/t)}function k(e){var t=te-re;return(1-e/X)*t+re}function M(e){var t=e.node.getClientRects()[0];return[t.left,t.top]}function q(e,t,n){var r=t.frequency,a=t.q,o=t.gain,i=Math.tan(Math.PI*r/O),s=1/(1+1/a*i+i*i),c=Math.pow(10,Math.abs(o)/20),l=0,u=0,d=0,m=0,f=0,v=h;"peaking"==t.t?(v=Z,o>=0?(s=1/(1+1/a*i+i*i),l=(1+c/a*i+i*i)*s,u=2*(i*i-1)*s,d=(1-c/a*i+i*i)*s,m=u,f=(1-1/a*i+i*i)*s):(s=1/(1+c/a*i+i*i),l=(1+1/a*i+i*i)*s,u=2*(i*i-1)*s,d=(1-Math.abs(c)/a*i+i*i)*s,m=u,f=(1-c/a*i+i*i)*s)):"highshelf"==t.t?(v=Y,o>=0?(s=1/(1+Math.SQRT2*i+i*i),l=(c+Math.sqrt(2*c)*i+i*i)*s,u=2*(i*i-c)*s,d=(c-Math.sqrt(2*c)*i+i*i)*s,m=2*(i*i-1)*s,f=(1-Math.SQRT2*i+i*i)*s):(s=1/(c+Math.sqrt(2*c)*i+i*i),l=(1+Math.SQRT2*i+i*i)*s,u=2*(i*i-1)*s,d=(1-Math.SQRT2*i+i*i)*s,m=2*(i*i-c)*s,f=(c-Math.sqrt(2*c)*i+i*i)*s)):"lowshelf"==t.t&&(v=Y,o>=0?(s=1/(1+Math.SQRT2*i+i*i),l=(1+Math.sqrt(2*c)*i+c*i*i)*s,u=2*(c*i*i-1)*s,d=(1-Math.sqrt(2*c)*i+c*i*i)*s,m=2*(i*i-1)*s,f=(1-Math.SQRT2*i+i*i)*s):(s=1/(1+Math.sqrt(2*c)*i+c*i*i),l=(1+Math.SQRT2*i+i*i)*s,u=2*(i*i-1)*s,d=(1-Math.SQRT2*i+i*i)*s,m=2*(c*i*i-1)*s,f=(1-Math.sqrt(2*c)*i+c*i*i)*s));for(var h=[],g=0;_>g;g+=2){var p=y(g/_)*Math.PI,k=Math.pow(Math.sin(p/2),2),M=Math.log((Math.pow(l+u+d,2)-4*(l*u+4*l*d+u*d)*k+16*l*d*k*k)/(Math.pow(1+m+f,2)-4*(m+4*f+m*f)*k+16*f*k*k));M=10*M/Math.LN10,M=E(M),M==-(1/0)&&(M=X-1),Math.abs(M-X/2)>1&&(h=h.concat([g,M]))}var q=null;q=o>=0?e.gradient("l(.5, 0, .5, 1)"+v+"-"+K):e.gradient("l(.5, 1, .5, 0)"+v+"-"+K),ce[n]&&ce[n].remove(),ce[n]=e.polyline(h).attr({stroke:q,"fill-opacity":"0","pointer-events":"none"})}function b(e,t){for(var n=0;n<t.length;n++){var r=t[n];q(e,r,n)}}function L(e){for(var t=5;ee>t;t*=2){var n=g(t);e.line(n,X/2+10,n,X/2-10).attr({stroke:V,"stroke-opacity":.25}),e.line(n,X,n,X-15).attr({stroke:V}),e.text(n,X-18,""+Math.round(h(n))).attr({fill:J,"text-anchor":"middle","font-size":10}),e.line(n,0,n,15).attr({stroke:V})}for(var r=5,a=re;te>a;a+=r){var o=E(a);Math.abs(te)-Math.abs(a)>r/2&&(e.line(0,o,5,o).attr({stroke:V}),e.text(7,o,""+a).attr({fill:J,"font-size":10,"dominant-baseline":"middle"}))}}function T(e){return.2>e&&(e=.2),e>11&&(e=11),e}function S(e){return function(t,n,r,a,o){var i=M(se);a-=i[1],0>a||a>=X||(k(a)>ne&&(n-=a-E(ne),a=E(ne)),e.y=a,e.gain=C(k(a)),this.attr({transform:this.data("origTransform")+(this.data("origTransform")?"T":"t")+[0,n]}),P(e))}}function B(t){return function(){this.attr({fill:K}),chrome.runtime.sendMessage({type:"gainUpdated",gain:t.gain}),e()}}function w(e,t,n){return function(r,a,o,i,s){if(s.shiftKey)e.q=T(e.q+s.movementY/10);else{var c=M(ae);if(o-=c[0],i-=c[1],0>o||o>=_||0>i||i>=X)return;e.x=o,e.y=i,e.gain=k(i),e.frequency=h(o),this.attr({transform:this.data("origTransform")+(this.data("origTransform")?"T":"t")+[r,a]})}q(n,e,t),I(e,t)}}function I(e,t){chrome.runtime.sendMessage({type:"modifyFilter",index:t,frequency:h(e.x),gain:k(e.y),q:e.q})}function C(e){return Math.pow(10,e/10)}function x(e){return 10*Math.log10(e)}function P(e){chrome.runtime.sendMessage({type:"modifyGain",gain:e.gain})}function F(e){chrome.runtime.sendMessage({type:"resetFilter",index:e})}function R(t,n){return function(){this.attr({fill:K}),chrome.runtime.sendMessage({type:"filterUpdated",filterType:t.t,frequency:t.frequency,gain:t.gain,q:t.q}),e()}}var Q=(chrome.runtime.getManifest().version,localStorage),N=null;document.addEventListener("DOMContentLoaded",function(n){t(),e(),o()}),document.addEventListener("DOMContentLoaded",function(){function e(e){o.textContent=e,o.classList.add("show"),setTimeout(function(){o.classList.remove("show")},5e3)}function t(){c()?f.classList.add("on"):f.classList.remove("on")}var n=document.getElementById("presetNameInput"),r=document.getElementById("resetFiltersButton");r.onclick=function(){n.value="",chrome.runtime.sendMessage({type:"resetFilters"})};var a=document.getElementById("bassBoostButton");a.onclick=function(){n.value="",chrome.runtime.sendMessage({type:"preset",preset:"bassBoost"})};var o=document.getElementById("requiresProDiv"),i=document.getElementById("savePresetButton");i.onclick=function(){if(N&&userPresetSpan.children.length>=N+1)return void e("Saving more than 3 presets requires Ears Pro. Click the Pro tab above to start your free trial!");var t=n.value.trim();""!=t?chrome.runtime.sendMessage({type:"savePreset",preset:t}):(e("Type a name in the Preset Name box, then click Save Preset or press Enter."),n.focus())};var s=document.getElementById("deletePresetButton");s.onclick=function(){var e=n.value.trim();""!=e&&chrome.runtime.sendMessage({type:"deletePreset",preset:e})},n.onkeypress=function(e){e||(e=window.event);var t=e.keyCode||e.which;return"13"==t&&document.activeElement==n?(i.click(),!1):void 0};var u=document.getElementById("exportPresetsButton");u.onclick=function(){chrome.runtime.sendMessage({type:"exportPresets"})};var d=document.getElementById("importPresetsButton"),m=document.getElementById("importPresetsFile");d.onclick=function(){m.click()},m.onchange=function(){for(var e=m.files,t=0;t<e.length;t++){var n=new FileReader;n.onload=function(e){chrome.runtime.sendMessage({type:"importPresets",presets:JSON.parse(e.target.result)})},n.readAsText(e[t])}};var f=document.getElementById("vizButton");t(),f.onclick=function(){N&&e("The frequency spectrum visualizer requires Ears Pro. Click the Pro tab above to start your free trial!"),l(),t()};for(var v=["tab-1","tab-2","tab-3"],h=0;h<v.length;h++){var g=v[h];document.getElementById(g).addEventListener("change",function(e){return function(){this.checked&&(localStorage["last-tab"]=e)}}(g))}var p=localStorage["last-tab"];if(p){var y=document.getElementById(p);y&&y.click()}window.innerWidth&&window.innerWidth>1e3&&(document.getElementById("fullscreen-link").style.display="none")});var O=44100,D="eqSvg",z="eqTabButton",U="How was your day of beautiful audio? Let us know what you think at the link below! If you would like to continue using Ears, please support us by making a purchase. If you have already purchased Ears, please restart Chrome. Enjoy!",W=!0,A=function(){W&&(e(),setTimeout(A,1e3))};setTimeout(A,1e3),chrome.runtime.onMessage.addListener(function(e,t,n){if("sendCurrentTabStatus"==e.type&&(e.streaming?s():i()),"sendWorkspaceStatus"==e.type&&(W=!1,u(e)),"sendSampleRate"==e.type&&(O=e.Fs,console.log("set sample rate to "+O)),"sendPresets"==e.type&&a(e),"F"==e.type){var r=document.getElementById(D);r&&r.remove();var o=document.getElementById(z);o&&o.remove(),document.getElementById("lt").textContent=U,document.getElementById("pl").style.display="block"}});var G="SHOW_VISUALIZER",H=[],j="rgba(230, 225, 214, 0.55)",V="rgba(230, 225, 214, 0.5)",J="rgba(230, 225, 214, 0.65)",K="#29313B",Y="#9573A8",Z="#CDF7E1",_=670,X=303,$=30,ee=22050,te=30,ne=10,re=-30,ae=null,oe=null,ie=null,se=null,ce={},le=function(){this.data("origTransform",this.transform().local),this.attr({fill:"black"})};c()&&r()}!function(){scope()}(),document.addEventListener("DOMContentLoaded",function(){function e(){o.paused||o.ended?a.classList.remove("is-playing"):a.classList.add("is-playing"),document.fullscreenElement===a?a.classList.add("is-fullscreen"):a.classList.remove("is-fullscreen"),o.muted||0===o.volume?(a.classList.add("is-muted"),a.classList.remove("is-low")):o.volume<=.4?(a.classList.remove("is-muted"),a.classList.add("is-low")):(a.classList.remove("is-muted"),a.classList.remove("is-low")),v&&document.activeElement!==v&&(v.value=o.muted?0:o.volume)}function t(){o.paused?o.play():o.pause()}function n(){o.muted=!o.muted,o.muted||0!==o.volume||(o.volume=.8),e()}function r(){document.fullscreenElement===a?document.exitFullscreen():a.requestFullscreen&&a.requestFullscreen()}var a=document.getElementById("demoPlayer"),o=document.getElementById("demoVideo");if(a&&o){var i=a.querySelector('[data-action="play"]'),s=a.querySelector('[data-action="pause"]'),c=a.querySelector('[data-action="expand"]'),l=a.querySelector('[data-action="compress"]'),u=a.querySelector('[data-action="volume"]'),d=a.querySelector('[data-action="volume-low"]'),m=a.querySelector('[data-action="volume-off"]'),f=a.querySelector('[data-action="volume-xmark"]'),v=a.querySelector(".volume-slider");i&&i.addEventListener("click",t),s&&s.addEventListener("click",t),c&&c.addEventListener("click",r),l&&l.addEventListener("click",r),u&&u.addEventListener("click",n),d&&d.addEventListener("click",n),m&&m.addEventListener("click",n),f&&f.addEventListener("click",n),v&&v.addEventListener("input",function(t){var n=parseFloat(t.target.value);isNaN(n)||(o.volume=n,o.muted=0===n,e())}),o.addEventListener("play",e),o.addEventListener("pause",e),o.addEventListener("volumechange",e),document.addEventListener("fullscreenchange",e),e()}});