/*
✨ CoonDev • https://dev.coonlink.com/

 ▄█▄    ████▄ ████▄    ▄   ██▄   ▄███▄      ▄
 █▀ ▀▄  █   █ █   █     █  █  █  █▀   ▀      █
 █   ▀  █   █ █   █ ██   █ █   █ ██▄▄   █     █
 █▄  ▄▀ ▀████ ▀████ █ █  █ █  █  █▄   ▄▀ █    █
 ▀███▀              █  █ █ ███▀  ▀███▀    █  █
                    █   ██                 █▐
                                           ▐
*/

function scope(){function e(e){v&&console.log(e)}function t(e){return u+e}function n(e){localStorage[c]||(localStorage[c]=JSON.stringify({}));var t=localStorage[c];t&&t.length>2e6&&(console.warn("Presets too large, resetting"),localStorage[c]=JSON.stringify({}),t=localStorage[c]);var n;try{n=JSON.parse(t)}catch(r){console.warn("Invalid presets JSON, resetting",r),localStorage[c]=JSON.stringify({}),n={}}(null==n||"object"!=typeof n)&&(n={}),g.get(null,function(t){chrome.runtime.lastError&&console.log(chrome.runtime.lastError);for(var r in t)r.startsWith(u)&&(n[r.slice(u.length)]=t[r]);e(n)})}function r(e,t,n){var r=localStorage[c];r&&r.length>2e6&&(console.warn("Presets too large, resetting"),localStorage[c]=JSON.stringify({}),r=localStorage[c]);var o;try{o=JSON.parse(r)}catch(a){console.warn("Invalid presets JSON, resetting",a),localStorage[c]=JSON.stringify({}),o={}}(null==o||"object"!=typeof o)&&(o={});var i=Object.keys(o).length;o[e]=t;var s=Object.keys(o).length;return d&&Object.keys(o)>d&&s>=i?void n():(localStorage[c]=JSON.stringify(o),syncPresets={},syncPresets[a(e)]=t,void g.set(syncPresets,function(){chrome.runtime.lastError&&console.log(chrome.runtime.lastError),n()}))}function o(e,n){var r=localStorage[c];r&&r.length>2e6&&(console.warn("Presets too large, resetting"),localStorage[c]=JSON.stringify({}),r=localStorage[c]);var o;try{o=JSON.parse(r)}catch(a){console.warn("Invalid presets JSON, resetting",a),localStorage[c]=JSON.stringify({}),o={}}(null==o||"object"!=typeof o)&&(o={}),delete o[e.preset],localStorage[c]=JSON.stringify(o),g.remove(t(e.preset),n)}function a(){if("undefined"!=typeof window.AudioContext)return new window.AudioContext({latencyHint:"playback"});if("undefined"!=typeof window.webkitAudioContext)return new window.webkitAudioContext({latencyHint:"playback"});throw new Error("Web Audio API is not supported in this browser.")}function i(){if(k){y.close(),y=null,k=!1,h=null,b=null;var e=Object.values(x);x={};for(var t=0;t<e.length;t++){var n=e[t].audioSource;n.disconnect(m)}s(e)}}function s(t){function s(){for(var t=S,n=!1,r=O.length-1;r>=0;r--)0!=O[r].gain.value?(Y[r]||(n=!0),n&&(e(r+" -> "+t.idx),O[r].disconnect(),O[r].connect(t)),Y[r]&&(n=!1),Y[r]=!0,t=O[r],t.idx=r):Y[r]&&(Y[r]=!1,n=!0);n&&(e("preGain -> "+t.idx),m.disconnect(),m.connect(t))}function c(e){f=O[e.index],f.gain.value=g(e.gain),f.frequency.value=v(e.frequency),f.Q.value=P(e.q);var t="filter"+e.index;localStorage[t]=JSON.stringify({f:f.frequency.value,g:f.gain.value,q:f.Q.value}),s()}function u(e){return e>10?10:.00316>e?.00316:e}function g(e){return-30>e?-30:e>30?30:e}function v(e){return 5>e?5:e>2e4?2e4:e}function P(e){return.2>e&&(e=.2),e>11&&(e=11),e}function A(e){var t=u(e.gain);S.gain.value=u(t),R(t)}function T(){return localStorage.GAIN||(localStorage.GAIN=JSON.stringify(1)),JSON.parse(localStorage.GAIN)}function R(e){localStorage.GAIN=JSON.stringify(e)}function C(e){for(var t=[],n=[],o=[],a=0;a<O.length;a++){var i=O[a];t.push(i.frequency.value),n.push(i.gain.value),o.push(i.Q.value)}var s={frequencies:t,gains:n,qs:o};r(e.preset,s,U)}function E(e){n(function(t){var n=[],r=[],o=[];if("bassBoost"==e.preset){for(var a=0;a<q.length;a++)n.push(q[a]),r.push(0),o.push(w[a]);n[0]=340,r[0]=5}else{var i=t[e.preset];if(!i)return;n=i.frequencies,r=i.gains,o=i.qs}for(var a=0;a<n.length;a++)c({index:a,frequency:n[a],gain:r[a],q:o[a]});U()})}function F(e,t){return t?(W(e,t,!0),s(),void U()):void Q(function(t){W(e,t,!0),s(),U()})}function j(e,t){return e?navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?void navigator.mediaDevices.getUserMedia({audio:{mandatory:{chromeMediaSource:"tab",chromeMediaSourceId:e}},video:!1}).then(function(e){F(e,t)})["catch"](function(e){console.error("tab audio capture failed",e)}):void console.error("getUserMedia is unavailable in this context"):void console.error("missing stream id for tab capture")}function I(){for(var e={type:"sendWorkspaceStatus",eqFilters:[],streams:[],gain:S.gain.value},t=0;t<O.length;t++){var n=O[t];e.eqFilters.push({frequency:n.frequency.value,gain:n.gain.value,type:n.type,q:n.Q.value})}for(var r in x)x[r].tab,e.streams.push(x[r].tab);chrome.runtime.sendMessage(e)}function M(){chrome.runtime.sendMessage({type:"sendSampleRate",Fs:y.sampleRate})}function G(){n(function(e){chrome.runtime.sendMessage({type:"sendPresets",presets:e})})}function U(){B(),I(),M(),G()}function Q(e){chrome.runtime.sendMessage({type:"getActiveTab"},function(t){return chrome.runtime.lastError?void console.error(chrome.runtime.lastError):t&&t.tab?void e(t.tab):void console.error("active tab not available")})}function B(){Q(function(e){chrome.runtime.sendMessage({type:"sendCurrentTabStatus",streaming:e.id in x})})}function W(e,t,n){if(!e)return void console.log("null stream, aborting");0==Object.keys(x).length&&y.resume(),t.id in x&&(console.log("had stream, stopping"),x[t.id].stream.getTracks()[0].stop(),delete x[t.id]);var r=y.createMediaStreamSource(e);r.connect(m),x[t.id]={stream:e,tab:t,audioSource:r}}function D(){Q(L)}function L(e){if(console.log("disconnectedTab id "+e.id),e.id in x){var t=x[e.id].stream;t.getTracks()[0].stop(),delete x[e.id]}0==Object.keys(x).length&&y.suspend(),U()}function H(){for(var e=0;N>e;e++)c({index:e,gain:0,frequency:q[e],q:w[e]});A({gain:1}),U()}function _(e){c({index:e.index,gain:0,frequency:q[e.index],q:w[e.index]})}function z(){function e(e,t){var n=document.createElement("a"),r=new Blob([t],{type:"text/plain;charset=UTF-8"});n.href=window.URL.createObjectURL(r),n.download=e,n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n)}n(function(t){e("EarsAudioToolkitPresets.json",JSON.stringify(t,null,2))})}var V=null;if(!k){k=!0,y=a(),y.suspend(),console.log("starting sampleRate: "+y.sampleRate);var K=!1;if(J=function(){if(!K){var e=a(),t=y.sampleRate&&e.sampleRate&&y.sampleRate!=e.sampleRate;t&&(console.log(e),console.log(y),K=!0),e.close(),t&&(console.log("sampleRate changed... reloading AudioContext"),i())}},m=y.createGain(),m.gain.value=1,S=y.createGain(),S.gain.value=T(),V){var X=y.createScriptProcessor(V);X.onaudioprocess=function(e){for(var t=e.inputBuffer,n=e.outputBuffer,r=0;r<n.numberOfChannels;r++)n.copyToChannel(t.getChannelData(r),r)},S.connect(X),X.connect(y.destination)}else S.connect(y.destination);localStorage[l]||(localStorage[l]="0.0.0")," "==localStorage[" "]&&" "!=localStorage.sync&&(n(function(e){for(var t=Object.keys(e),n=0;n<t.length;n++){var o=t[n];r(o,e[o],function(){})}}),localStorage.sync=" "),O=[];for(var Y={},Z=0;N>Z;Z++){var $=y.createBiquadFilter();0==Z?$.type="lowshelf":Z==N-1?$.type="highshelf":$.type="peaking";var ee="filter"+Z,te=localStorage[ee];te?(te=JSON.parse(te),$.frequency.value=te.f,$.gain.value=te.g,$.Q.value=te.q):($.frequency.value=q[Z],$.gain.value=0,$.Q.value=w[Z]),O.push($),localStorage[ee]=JSON.stringify({f:$.frequency.value,g:$.gain.value,q:$.Q.value})}if(m.connect(S),p=function(e,t,n){if(e&&e.__fromServiceWorker===!0){if("eqTab"==e.type)if(e.on){if(e.tab&&e.tab.url&&e.tab.url.startsWith("chrome-extension://"+chrome.runtime.id))return;if(e.streamId)return void j(e.streamId,e.tab);console.error("stream id missing for eqTab")}else D();if("getCurrentTabStatus"==e.type&&B(),"getWorkspaceStatus"==e.type&&I(),"getFullRefresh"==e.type&&U(),"onPopupOpen"==e.type&&J(),"modifyFilter"==e.type&&c(e),"modifyGain"==e.type&&A(e),"gainUpdated"==e.type,"filterUpdated"==e.type,"disconnectTab"==e.type&&L(e.tab),"resetFilters"==e.type&&H(),"resetFilter"==e.type&&_(e),"preset"==e.type&&E(e),"savePreset"==e.type&&C(e),"importPresets"==e.type)for(var a=e.presets,i=Object.keys(a),s=0;s<i.length;s++)r(i[s],a[i[s]],U);if("deletePreset"==e.type&&o(e,U),"exportPresets"==e.type&&z(),"getFFT"==e.type){if(d)return void chrome.runtime.sendMessage({type:"fft",fft:[]});if(h){b=performance.now();var l=new Float32Array(h.frequencyBinCount);h.getFloatFrequencyData(l),n({type:"fft",fft:Array.from(l)})}else h=y.createAnalyser(),h.fftSize=8192,h.smoothingTimeConstant=.5,console.log("created analyser"),console.log(h),S.connect(h),n({type:"fft",fft:[]})}}},t){for(var Z=0;Z<t.length;Z++)W(t[Z].stream,t[Z].tab,!1);s(),U()}else chrome.runtime.onMessage.addListener(p)}}var l="VERSION",c="PRESETS",u="PRESETS.",g={get:function(e,t){t({})},set:function(e,t){t()},remove:function(e,t){t()}},d=null;d=null;var p,v=!1,y=null,m=null,S=null,h=null,b=null,O=[],q=[20,40,80,160,320,640,1280,2560,5120,10240,20480],w=[.7071,.7071,.7071,.7071,.7071,.7071,.7071,.7071,.7071,.7071,.7071],N=11,J=function(){},x={},k=!1;s(),setInterval(function(){b&&performance.now()-b>1e3&&S&&h&&(S.disconnect(h),h=null,console.log("disconnected analyser"))},1e3)}scope();