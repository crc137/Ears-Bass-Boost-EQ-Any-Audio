/*
✨ CoonDev • https://dev.coonlink.com/

 ▄█▄    ████▄ ████▄    ▄   ██▄   ▄███▄      ▄
 █▀ ▀▄  █   █ █   █     █  █  █  █▀   ▀      █
 █   ▀  █   █ █   █ ██   █ █   █ ██▄▄   █     █
 █▄  ▄▀ ▀████ ▀████ █ █  █ █  █  █▄   ▄▀ █    █
 ▀███▀              █  █ █ ███▀  ▀███▀    █  █
                    █   ██                 █▐
                                           ▐
*/

function scope(){function e(e){g&&console.log(e)}function t(e){return u+e}function n(e){localStorage[l]||(localStorage[l]=JSON.stringify({}));var t=JSON.parse(localStorage[l]);(null==t||"object"!=typeof t)&&(t={}),d.get(null,function(n){chrome.runtime.lastError&&console.log(chrome.runtime.lastError);for(var r in n)r.startsWith(u)&&(t[r.slice(u.length)]=n[r]);e(t)})}function r(e,n,r){var a=JSON.parse(localStorage[l]);(null==a||"object"!=typeof a)&&(a={});var o=Object.keys(a).length;a[e]=n;var i=Object.keys(a).length;return m&&Object.keys(a)>m&&i>=o?void r():(localStorage[l]=JSON.stringify(a),syncPresets={},syncPresets[t(e)]=n,void d.set(syncPresets,function(){chrome.runtime.lastError&&console.log(chrome.runtime.lastError),r()}))}function a(e,n){var r=JSON.parse(localStorage[l]);(null==r||"object"!=typeof r)&&(r={}),delete r[e.preset],localStorage[l]=JSON.stringify(r),d.remove(t(e.preset),n)}function o(){if("undefined"!=typeof window.AudioContext)return new window.AudioContext({latencyHint:"playback"});if("undefined"!=typeof window.webkitAudioContext)return new window.webkitAudioContext({latencyHint:"playback"});throw new Error("Web Audio API is not supported in this browser.")}function i(){if(x){p.close(),p=null,x=!1,b=null,S=null;var e=Object.values(T);T={};for(var t=0;t<e.length;t++){var n=e[t].audioSource;n.disconnect(h)}s(e)}}function s(t){function s(){for(var t=y,n=!1,r=q.length-1;r>=0;r--)0!=q[r].gain.value?(Z[r]||(n=!0),n&&(e(r+" -> "+t.idx),q[r].disconnect(),q[r].connect(t)),Z[r]&&(n=!1),Z[r]=!0,t=q[r],t.idx=r):Z[r]&&(Z[r]=!1,n=!0);n&&(e("preGain -> "+t.idx),h.disconnect(),h.connect(t))}function l(e){f=q[e.index],f.gain.value=d(e.gain),f.frequency.value=g(e.frequency),f.Q.value=C(e.q);var t="filter"+e.index;localStorage[t]=JSON.stringify({f:f.frequency.value,g:f.gain.value,q:f.Q.value}),s()}function u(e){return e>10?10:.00316>e?.00316:e}function d(e){return-30>e?-30:e>30?30:e}function g(e){return 5>e?5:e>2e4?2e4:e}function C(e){return.2>e&&(e=.2),e>11&&(e=11),e}function L(e){var t=u(e.gain);y.gain.value=u(t),B(t)}function I(){return localStorage.GAIN||(localStorage.GAIN=JSON.stringify(1)),JSON.parse(localStorage.GAIN)}function B(e){localStorage.GAIN=JSON.stringify(e)}function P(e){for(var t=[],n=[],a=[],o=0;o<q.length;o++){var i=q[o];t.push(i.frequency.value),n.push(i.gain.value),a.push(i.Q.value)}var s={frequencies:t,gains:n,qs:a};r(e.preset,s,j)}function F(e){n(function(t){var n=[],r=[],a=[];if("bassBoost"==e.preset){for(var o=0;o<k.length;o++)n.push(k[o]),r.push(0),a.push(E[o]);n[0]=340,r[0]=5}else{var i=t[e.preset];if(!i)return;n=i.frequencies,r=i.gains,a=i.qs}for(var o=0;o<n.length;o++)l({index:o,frequency:n[o],gain:r[o],q:a[o]});j()})}function O(e,t){return t?(D(e,t,!0),s(),void j()):void J(function(t){D(e,t,!0),s(),j()})}function R(e,t){return e?navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?void navigator.mediaDevices.getUserMedia({audio:{mandatory:{chromeMediaSource:"tab",chromeMediaSourceId:e}},video:!1}).then(function(e){O(e,t)})["catch"](function(e){console.error("tab audio capture failed",e)}):void console.error("getUserMedia is unavailable in this context"):void console.error("missing stream id for tab capture")}function N(){for(var e={type:"sendWorkspaceStatus",eqFilters:[],streams:[],gain:y.gain.value},t=0;t<q.length;t++){var n=q[t];e.eqFilters.push({frequency:n.frequency.value,gain:n.gain.value,type:n.type,q:n.Q.value})}for(var r in T){T[r].tab;e.streams.push(T[r].tab)}chrome.runtime.sendMessage(e)}function Q(){chrome.runtime.sendMessage({type:"sendSampleRate",Fs:p.sampleRate})}function A(){n(function(e){chrome.runtime.sendMessage({type:"sendPresets",presets:e})})}function j(){U(),N(),Q(),A()}function J(e){chrome.runtime.sendMessage({type:"getActiveTab"},function(t){return chrome.runtime.lastError?void console.error(chrome.runtime.lastError):t&&t.tab?void e(t.tab):void console.error("active tab not available")})}function U(){J(function(e){chrome.runtime.sendMessage({type:"sendCurrentTabStatus",streaming:e.id in T})})}function D(e,t,n){if(!e)return void console.log("null stream, aborting");0==Object.keys(T).length&&p.resume(),t.id in T&&(console.log("had stream, stopping"),T[t.id].stream.getTracks()[0].stop(),delete T[t.id]);var r=p.createMediaStreamSource(e);r.connect(h),T[t.id]={stream:e,tab:t,audioSource:r}}function G(){J(W)}function W(e){if(console.log("disconnectedTab id "+e.id),e.id in T){var t=T[e.id].stream;t.getTracks()[0].stop(),delete T[e.id]}0==Object.keys(T).length&&p.suspend(),j()}function z(){for(var e=0;M>e;e++)l({index:e,gain:0,frequency:k[e],q:E[e]});L({gain:1}),j()}function H(e){l({index:e.index,gain:0,frequency:k[e.index],q:E[e.index]})}function V(){function e(e,t){var n=document.createElement("a"),r=new Blob([t],{type:"text/plain;charset=UTF-8"});n.href=window.URL.createObjectURL(r),n.download=e,n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n)}n(function(t){e("EarsAudioToolkitPresets.json",JSON.stringify(t,null,2))})}var _=null;if(!x){x=!0,p=o(),p.suspend(),console.log("starting sampleRate: "+p.sampleRate);var K=!1;if(w=function(){if(!K){var e=o(),t=p.sampleRate&&e.sampleRate&&p.sampleRate!=e.sampleRate;t&&(console.log(e),console.log(p),K=!0),e.close(),t&&(console.log("sampleRate changed... reloading AudioContext"),i())}},h=p.createGain(),h.gain.value=1,y=p.createGain(),y.gain.value=I(),_){var Y=p.createScriptProcessor(_);Y.onaudioprocess=function(e){for(var t=e.inputBuffer,n=e.outputBuffer,r=0;r<n.numberOfChannels;r++)n.copyToChannel(t.getChannelData(r),r)},y.connect(Y),Y.connect(p.destination)}else y.connect(p.destination);localStorage[c]||(localStorage[c]="0.0.0")," "==localStorage[" "]&&" "!=localStorage.sync&&(n(function(e){for(var t=Object.keys(e),n=0;n<t.length;n++){var a=t[n];r(a,e[a],function(){})}}),localStorage.sync=" "),q=[];for(var Z={},X=0;M>X;X++){var $=p.createBiquadFilter();0==X?$.type="lowshelf":X==M-1?$.type="highshelf":$.type="peaking";var ee="filter"+X,te=localStorage[ee];te?(te=JSON.parse(te),$.frequency.value=te.f,$.gain.value=te.g,$.Q.value=te.q):($.frequency.value=k[X],$.gain.value=0,$.Q.value=E[X]),q.push($),localStorage[ee]=JSON.stringify({f:$.frequency.value,g:$.gain.value,q:$.Q.value})}h.connect(y);if(v=function(e,t,n){if(e&&e.__fromServiceWorker===!0){if("eqTab"==e.type)if(e.on){if(e.tab&&e.tab.url&&e.tab.url.startsWith("chrome-extension://"+chrome.runtime.id))return;if(e.streamId)return void R(e.streamId,e.tab);console.error("stream id missing for eqTab")}else G();if("getCurrentTabStatus"==e.type&&U(),"getWorkspaceStatus"==e.type&&N(),"getFullRefresh"==e.type&&j(),"onPopupOpen"==e.type&&w(),"modifyFilter"==e.type&&l(e),"modifyGain"==e.type&&L(e),"gainUpdated"==e.type,"filterUpdated"==e.type,"disconnectTab"==e.type&&W(e.tab),"resetFilters"==e.type&&z(),"resetFilter"==e.type&&H(e),"preset"==e.type&&F(e),"savePreset"==e.type&&P(e),"importPresets"==e.type)for(var o=e.presets,i=Object.keys(o),s=0;s<i.length;s++)r(i[s],o[i[s]],j);if("deletePreset"==e.type&&a(e,j),"exportPresets"==e.type&&V(),"getFFT"==e.type){if(m)return void chrome.runtime.sendMessage({type:"fft",fft:[]});if(b){S=performance.now();var c=new Float32Array(b.frequencyBinCount);b.getFloatFrequencyData(c),n({type:"fft",fft:Array.from(c)})}else b=p.createAnalyser(),b.fftSize=8192,b.smoothingTimeConstant=.5,console.log("created analyser"),console.log(b),y.connect(b),n({type:"fft",fft:[]})}}},t){for(var X=0;X<t.length;X++)D(t[X].stream,t[X].tab,!1);s(),j()}else chrome.runtime.onMessage.addListener(v)}}var c="VERSION",l="PRESETS",u="PRESETS.",d={get:function(e,t){t({})},set:function(e,t){t()},remove:function(e,t){t()}},m=null;m=null;var v,g=!1,p=null,h=null,y=null,b=null,S=null,q=[],k=[20,40,80,160,320,640,1280,2560,5120,10240,20480],E=[.7071,.7071,.7071,.7071,.7071,.7071,.7071,.7071,.7071,.7071,.7071],M=11,w=function(){},T={},x=!1;s(),setInterval(function(){S&&performance.now()-S>1e3&&y&&b&&(y.disconnect(b),b=null,console.log("disconnected analyser"))},1e3)}scope();